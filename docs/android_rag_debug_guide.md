# 安卓RAG调试指南

## 问题描述
在安卓平台上，RAG（检索增强生成）系统的检索结果始终为空，但在PC上运行正常。

## 可能的原因

### 1. API密钥配置问题
- **问题**：安卓上的配置文件可能没有正确加载API密钥
- **检查**：确认 `user://ai_keys.json` 文件在安卓上是否存在且包含正确的API密钥

### 2. 网络权限问题
- **问题**：安卓应用可能没有网络访问权限
- **检查**：确认 `export_presets.cfg` 中已启用：
  - `permissions/internet=true`
  - `permissions/access_network_state=true`

### 3. 文件路径问题
- **问题**：`user://` 路径在安卓上的实际位置不同
- **安卓路径**：通常是 `/data/data/cabm.ed/files/`
- **检查**：记忆文件 `user://memory_main_memory.json` 是否存在

### 4. 嵌入API调用失败
- **问题**：网络请求超时或API返回错误
- **原因**：
  - Base URL不可访问
  - API密钥认证失败（401错误）
  - 网络连接不稳定
  - 防火墙或代理问题

### 5. 记忆数据未同步
- **问题**：PC上生成的记忆数据没有传输到安卓设备
- **解决**：需要手动复制 `user://memory_main_memory.json` 文件

## 使用调试工具

### 步骤1：添加调试面板到游戏
在你的主场景或设置界面中添加一个按钮来打开调试面板：

```gdscript
func _on_debug_button_pressed():
	var debug_panel = load("res://scenes/android_rag_debug_panel.tscn").instantiate()
	add_child(debug_panel)
```

### 步骤2：在安卓设备上运行测试
1. 打开游戏
2. 点击调试按钮
3. 点击"开始测试RAG系统"
4. 等待测试完成（约10-30秒）
5. 查看测试结果

### 步骤3：导出日志
1. 点击"导出调试日志"
2. 日志会保存到：
   - 优先：`Documents/android_rag_debug.txt`
   - 备选：`user://android_rag_debug.txt`

### 步骤4：分析日志
查看日志中的关键信息：
- ✓ 表示正常
- ✗ 表示错误
- ⚠ 表示警告

重点关注：
1. **配置检查**：API密钥是否配置
2. **嵌入API测试**：是否返回空向量
3. **检索测试**：是否返回结果

## 常见问题解决方案

### 问题1：嵌入API调用失败
**症状**：日志显示"嵌入API调用失败，返回空向量"

**解决方案**：
1. 检查API密钥是否正确配置
2. 在PC上测试API是否可访问
3. 检查安卓设备的网络连接
4. 尝试使用移动数据而非WiFi（或反之）

### 问题2：记忆文件不存在
**症状**：日志显示"记忆文件不存在"

**解决方案**：
1. 在PC上使用一段时间，生成记忆数据
2. 找到PC上的 `user://memory_main_memory.json` 文件
3. 使用adb或文件管理器复制到安卓设备：
   ```bash
   adb push memory_main_memory.json /sdcard/
   # 然后在应用内移动到正确位置
   ```

### 问题3：记忆库为空
**症状**：日志显示"记忆库为空，无法测试检索"

**解决方案**：
1. 确保已经有对话记录并生成了总结
2. 检查 `UnifiedMemorySaver` 是否正常工作
3. 手动触发一次对话总结

### 问题4：检索结果为空但记忆库不为空
**症状**：有记忆数据但检索不到结果

**可能原因**：
1. 查询向量获取失败（API问题）
2. 相似度阈值过高（默认0.6）
3. 向量数据损坏

**解决方案**：
1. 降低相似度阈值（在 `ai_config.json` 中修改 `min_similarity`）
2. 重新生成记忆数据
3. 检查向量维度是否匹配

## 手动检查清单

### 在PC上
- [ ] 确认RAG功能正常工作
- [ ] 找到 `user://memory_main_memory.json` 文件
- [ ] 记录文件大小和记录数量
- [ ] 导出 `user://ai_keys.json` 配置文件

### 在安卓上
- [ ] 确认网络权限已启用
- [ ] 确认API密钥已配置
- [ ] 运行调试工具
- [ ] 导出并分析日志
- [ ] 如需要，手动复制记忆文件

## 临时解决方案

如果无法立即解决，可以考虑：

1. **禁用长期记忆**：在 `ai_config.json` 中设置：
   ```json
   "memory": {
     "vector_db": {
       "enable": false
     }
   }
   ```

2. **仅使用短期记忆**：依赖 `max_memory_items` 和 `max_conversation_history`

3. **使用本地嵌入模型**：如果有本地推理能力，避免网络调用

## 获取更多帮助

如果问题仍未解决，请提供：
1. 完整的调试日志
2. `ai_config.json` 配置（隐藏API密钥）
3. 安卓版本和设备型号
4. 网络环境描述（WiFi/移动数据/VPN等）
