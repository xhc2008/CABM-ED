# BGM系统升级说明

## 新功能概述

### 1. 播放模式
- **单曲循环**：重复播放当前音乐
- **顺序播放**：按列表顺序播放，播放完最后一首后从头开始
- **随机播放**：随机选择音乐播放，确保所有音乐都播放一遍后再重新随机

### 2. 场景音乐列表
- 每个场景可以有独立的音乐列表
- 如果场景没有设置音乐，自动使用"全部"场景的设置
- 支持在不同场景使用不同的播放模式

### 3. 编辑模式
- 点击"编辑"按钮进入编辑模式
- 在编辑模式下，可以勾选/取消勾选音乐来启用/禁用
- 点击"完成"按钮保存修改并退出编辑模式
- 关闭窗口或切换场景时自动保存并退出编辑模式

### 4. 音乐上传
- 在"全部"场景上传：音乐添加到全局列表，但不自动启用
- 在其他场景上传：音乐添加到全局列表，并在当前场景自动启用

### 5. 音乐删除
- 在"全部"场景中，"删除"按钮可见
- 在其他场景中，删除功能通过编辑模式的取消勾选实现（不是真正删除文件）
- 只有在"全部"场景中删除才会真正删除文件

## UI布局

```
┌─────────────────────────────────────────────────────┐
│                   🎵 音乐播放器                      │
├──────────┬──────────────────────┬───────────────────┤
│ 场景列表  │    音乐列表           │   播放模式/操作    │
│          │                      │                   │
│ ☑ 全部   │ ▶ 音乐1.mp3         │  播放模式:        │
│ ☐ 客厅   │   音乐2.mp3         │  ☑ 单曲循环       │
│ ☐ 卧室   │   音乐3.mp3 [自定义] │  ☐ 顺序播放       │
│ ☐ 书房   │                      │  ☐ 随机播放       │
│ ...      │                      │                   │
│          │                      │  [编辑]           │
│          │                      │  [上传音乐]       │
│          │                      │  [删除选中]       │
└──────────┴──────────────────────┴───────────────────┘
```

## 使用流程

### 为场景设置音乐

1. 打开音乐播放器
2. 在左侧选择要设置的场景
3. 点击"编辑"按钮
4. 勾选要在该场景播放的音乐
5. 点击"完成"保存

### 上传自定义音乐

1. 点击"上传音乐"按钮
2. 选择音频文件（支持MP3、OGG、WAV格式）
3. 如果在特定场景中上传，音乐会自动在该场景启用

### 切换播放模式

1. 在右侧"播放模式"区域选择模式
2. 设置会立即保存并应用

### 播放音乐

1. 在音乐列表中点击任意音乐开始播放
2. 系统会根据当前播放模式播放整个列表

## 数据保存

所有BGM配置（包括每个场景的启用音乐列表和播放模式）都保存在存档文件中，通过SaveManager管理。

配置结构：
```json
{
  "bgm_config": {
    "all": {
      "enabled_music": ["path/to/music1.mp3", "path/to/music2.mp3"],
      "play_mode": 1
    },
    "livingroom": {
      "enabled_music": ["path/to/music3.mp3"],
      "play_mode": 0
    }
  }
}
```

## 注意事项

1. **编辑模式下的意外情况处理**：
   - 关闭窗口：自动保存并退出编辑模式
   - 切换场景：自动保存并退出编辑模式
   - 切换选项卡：编辑模式仅在"切换音乐"选项卡有效

2. **播放模式值**：
   - 0 = 单曲循环 (SINGLE_LOOP)
   - 1 = 顺序播放 (SEQUENTIAL)
   - 2 = 随机播放 (RANDOM)

3. **文件格式支持**：
   - 推荐使用OGG格式（跨平台兼容性最好）
   - MP3和WAV也支持
   - 不支持AAC/M4A格式

## 技术实现

### AudioManager新增功能

- `PlayMode` 枚举：定义三种播放模式
- `play_playlist()`: 播放播放列表
- `set_play_mode()`: 设置播放模式
- `_play_next_track()`: 顺序播放下一首
- `_play_random_track()`: 随机播放

### SaveManager新增功能

- `get_bgm_config()`: 获取BGM配置
- `set_bgm_config()`: 保存BGM配置

### MusicPlayerPanel重构

- 三栏布局：场景列表、音乐列表、操作面板
- 编辑模式切换
- 场景音乐配置管理
- 播放模式UI
