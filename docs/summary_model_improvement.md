# Summary Model å ä½ç¬¦æ”¯æŒ

## æ”¹è¿›è¯´æ˜

ç°åœ¨ `summary_model` çš„ `system_prompt` æ”¯æŒä½¿ç”¨å ä½ç¬¦ï¼Œå¯ä»¥è®©æ€»ç»“ä»¥è§’è‰²çš„è§†è§’è¿›è¡Œã€‚

## æ”¯æŒçš„å ä½ç¬¦

åœ¨ `summary_model.system_prompt` ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å ä½ç¬¦ï¼š

- `{character_name}` - è§’è‰²åç§°
- `{user_name}` - ç”¨æˆ·åç§°
- `{user_address}` - è§’è‰²å¯¹ç”¨æˆ·çš„ç§°å‘¼
- `{word_limit}` - åŠ¨æ€å­—æ•°é™åˆ¶ï¼ˆæ ¹æ®å¯¹è¯æ¡æ•°è‡ªåŠ¨è®¡ç®—ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### å®¢è§‚æ€»ç»“ï¼ˆæ—§æ–¹å¼ï¼‰
```json
"system_prompt": "ä½ æ˜¯ä¸€ä¸ªæ€»ç»“ä¸“å®¶ã€‚è¯·å°†ä¸¤äººçš„å¯¹è¯æ€»ç»“æˆç®€çŸ­çš„æè¿°ï¼Œä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡50å­—ã€‚/no_think"
```

**æ•ˆæœ**ï¼šç”Ÿæˆå®¢è§‚çš„ç¬¬ä¸‰äººç§°æ€»ç»“
- ç¤ºä¾‹ï¼šã€Œç”¨æˆ·å’Œè§’è‰²è®¨è®ºäº†ä»Šå¤©çš„å¤©æ°”ï¼Œè§’è‰²è¡¨ç¤ºå¾ˆå–œæ¬¢æ™´å¤©ã€‚ã€

### è§’è‰²è§†è§’æ€»ç»“ï¼ˆæ–°æ–¹å¼ï¼‰
```json
"system_prompt": "ä½ æ˜¯{character_name}ã€‚è¯·ä»¥ä½ çš„è§†è§’ï¼Œç”¨ç¬¬ä¸€äººç§°æ€»ç»“ä½ å’Œ{user_address}çš„å¯¹è¯ï¼Œä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡{word_limit}å­—ã€‚/no_think"
```

**æ•ˆæœ**ï¼šç”Ÿæˆè§’è‰²ç¬¬ä¸€äººç§°çš„æ€»ç»“ï¼Œå­—æ•°é™åˆ¶ä¼šæ ¹æ®å¯¹è¯é•¿åº¦è‡ªåŠ¨è°ƒæ•´
- ç¤ºä¾‹ï¼šã€Œæˆ‘å’Œä¸»äººèŠäº†ä»Šå¤©çš„å¤©æ°”ï¼Œæˆ‘å‘Šè¯‰ä»–æˆ‘å¾ˆå–œæ¬¢æ™´å¤©ã€‚ã€

### æ›´å¤šç¤ºä¾‹

#### æ—¥è®°é£æ ¼
```json
"system_prompt": "ä½ æ˜¯{character_name}ã€‚è¯·ä»¥æ—¥è®°çš„å½¢å¼ï¼Œç”¨ç¬¬ä¸€äººç§°è®°å½•ä½ å’Œ{user_address}åˆšæ‰çš„å¯¹è¯ï¼Œä¸è¶…è¿‡{word_limit}å­—ã€‚/no_think"
```

#### ç®€çŸ­è®°å½•
```json
"system_prompt": "ä½ æ˜¯{character_name}ã€‚ç”¨ä¸€å¥è¯è®°å½•ä½ åˆšæ‰å’Œ{user_address}èŠäº†ä»€ä¹ˆã€‚/no_think"
```

#### æƒ…æ„Ÿè®°å½•
```json
"system_prompt": "ä½ æ˜¯{character_name}ã€‚æ€»ç»“ä½ å’Œ{user_address}çš„å¯¹è¯ï¼Œé‡ç‚¹æè¿°ä½ çš„æ„Ÿå—å’Œæƒ…ç»ªï¼Œä¸è¶…è¿‡{word_limit}å­—ã€‚/no_think"
```

## åŠ¨æ€å­—æ•°é™åˆ¶

ç³»ç»Ÿä¼šæ ¹æ®å¯¹è¯æ¡æ•°è‡ªåŠ¨è°ƒæ•´æ€»ç»“çš„å­—æ•°é™åˆ¶ï¼š

| å¯¹è¯æ¡æ•° | å­—æ•°é™åˆ¶ |
|---------|---------|
| 1-2æ¡   | 30å­—    |
| 3-4æ¡   | 50å­—    |
| 5-6æ¡   | 70å­—    |
| 7-8æ¡   | 90å­—    |
| 9æ¡ä»¥ä¸Š | 110å­—   |

è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š
- çŸ­å¯¹è¯ä¸ä¼šè¿‡åº¦æ€»ç»“ï¼Œä¿æŒç®€æ´
- é•¿å¯¹è¯æœ‰è¶³å¤Ÿç©ºé—´è®°å½•æ›´å¤šç»†èŠ‚
- æ€»ç»“é•¿åº¦ä¸å¯¹è¯å†…å®¹é‡ç›¸åŒ¹é…

## æŠ€æœ¯å®ç°

ä¿®æ”¹ä½ç½®ï¼š`scripts/ai_service.gd` ä¸­çš„ `_call_summary_api` å‡½æ•°

```gdscript
# è·å–è§’è‰²å’Œç”¨æˆ·ä¿¡æ¯
var save_mgr = get_node("/root/SaveManager")
var char_name = save_mgr.get_character_name()
var user_name = save_mgr.get_user_name()
var user_address = save_mgr.get_user_address()

# æ ¹æ®å¯¹è¯æ¡æ•°åŠ¨æ€è®¡ç®—å­—æ•°é™åˆ¶
var conversation_count = current_conversation.size()
var word_limit = _calculate_word_limit(conversation_count)

# æ›¿æ¢å ä½ç¬¦
var system_prompt = summary_config.system_prompt
system_prompt = system_prompt.replace("{character_name}", char_name)
system_prompt = system_prompt.replace("{user_name}", user_name)
system_prompt = system_prompt.replace("{user_address}", user_address)
system_prompt = system_prompt.replace("{word_limit}", str(word_limit))
```

å­—æ•°é™åˆ¶è®¡ç®—å‡½æ•°ï¼š

```gdscript
func _calculate_word_limit(conversation_count: int) -> int:
	"""æ ¹æ®å¯¹è¯æ¡æ•°åŠ¨æ€è®¡ç®—å­—æ•°é™åˆ¶"""
	if conversation_count <= 2:
		return 30
	elif conversation_count <= 4:
		return 50
	elif conversation_count <= 6:
		return 70
	elif conversation_count <= 8:
		return 90
	else:
		return 110
```

## é…ç½®æ–‡ä»¶

ä¿®æ”¹ `config/ai_config.json` ä¸­çš„ `summary_model.system_prompt` å³å¯ã€‚

## æ³¨æ„äº‹é¡¹

1. å ä½ç¬¦ä¼šåœ¨è¿è¡Œæ—¶è‡ªåŠ¨æ›¿æ¢ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
2. å¦‚æœä¸ä½¿ç”¨å ä½ç¬¦ï¼Œä¿æŒåŸæœ‰çš„promptä¹Ÿå®Œå…¨å¯ä»¥
3. å ä½ç¬¦åŒºåˆ†å¤§å°å†™ï¼Œå¿…é¡»å®Œå…¨åŒ¹é…
4. å»ºè®®åœ¨promptæœ«å°¾ä¿ç•™ `/no_think` ä»¥æé«˜å“åº”é€Ÿåº¦
5. `{word_limit}` å ä½ç¬¦ä¼šæ ¹æ®å¯¹è¯æ¡æ•°è‡ªåŠ¨è®¡ç®—ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

## ä¸æ—¥è®°ç³»ç»Ÿçš„é…åˆ

ç”±äºæ—¥è®°ç³»ç»Ÿç°åœ¨ç»Ÿä¸€æ˜¾ç¤ºæ‰€æœ‰è®°å½•ï¼ˆå¯¹è¯å’Œç¦»çº¿äº‹ä»¶ï¼‰ï¼Œä½¿ç”¨è§’è‰²è§†è§’çš„æ€»ç»“å¯ä»¥è®©æ—¥è®°æ›´åŠ è¿è´¯å’Œæœ‰ä»£å…¥æ„Ÿã€‚

**ç¤ºä¾‹æ—¥è®°æ˜¾ç¤º**ï¼š
```
ğŸ’¬ 14:30
æˆ‘å’Œä¸»äººèŠäº†ä»Šå¤©çš„å¤©æ°”ï¼Œæˆ‘å‘Šè¯‰ä»–æˆ‘å¾ˆå–œæ¬¢æ™´å¤©ã€‚

â° 15:00
æˆ‘åœ¨å®¢å…çœ‹äº†ä¸€ä¼šå„¿ä¹¦ï¼Œç„¶åå»å¨æˆ¿å‡†å¤‡äº†ä¸‹åˆèŒ¶ã€‚

ğŸ’¬ 16:20
ä¸»äººé—®æˆ‘æƒ³å»å“ªé‡Œç©ï¼Œæˆ‘è¯´æƒ³å»å…¬å›­æ•£æ­¥ã€‚
```

è¿™æ ·çš„æ—¥è®°è¯»èµ·æ¥å°±åƒæ˜¯è§’è‰²çš„ç§äººæ—¥è®°ï¼Œæ›´æœ‰æ²‰æµ¸æ„Ÿã€‚

## ç›¸å…³æ–‡æ¡£

- `docs/diary_system_improvement.md` - æ—¥è®°ç³»ç»Ÿæ”¹è¿›è¯´æ˜
- `config/ai_config.json` - AIé…ç½®æ–‡ä»¶
- `scripts/ai_service.gd` - AIæœåŠ¡å®ç°
