# BGM系统UI优化

## 优化内容

### 0. 按钮显示逻辑优化
**问题**："上传音乐"和"删除选中"按钮时不时消失又时不时出现，逻辑混乱。

**解决方案**：
- **"全部"场景**：显示"上传音乐"和"删除选中"按钮，隐藏"编辑"按钮
- **其他场景**：只显示"编辑"按钮，隐藏"上传音乐"和"删除选中"
- 逻辑更清晰：
  - 在"全部"场景管理所有音乐（上传、删除）
  - 在其他场景配置该场景的音乐（编辑、勾选）

**代码位置**：`scripts/music_player_panel.gd` - `_update_ui_for_scene()`

### 1. 场景未配置音乐时的显示
**问题**：场景未配置音乐时，提示标签和"全部"场景的音乐列表同时显示，界面混乱。

**解决方案**：
- **非编辑模式**：场景未配置音乐时，只显示提示标签，不显示音乐列表
- **编辑模式**：始终显示所有音乐的勾选列表，方便用户配置
- 提示内容更清晰：
  ```
  该场景未配置音乐，沿用"全部"场景的设置
  点击"编辑"按钮可为该场景单独配置音乐
  ```
- 用户点击"编辑"按钮后，可以看到所有音乐并进行勾选

**代码位置**：`scripts/music_player_panel.gd` - `_refresh_music_list()`

### 2. 随机播放模式下点击音乐的行为
**问题**：在随机播放模式下，用户点击某首音乐，系统会随机播放另一首，而不是播放用户点击的那首。

**解决方案**：
- 用户点击音乐时，始终先播放该音乐
- 播放完该音乐后，再根据播放模式决定下一首：
  - 单曲循环：重复播放该音乐
  - 顺序播放：播放列表中的下一首
  - 随机播放：随机选择下一首（已播放的除外）

**代码位置**：
- `scripts/audio_manager.gd` - `play_playlist()`
- 修改逻辑：即使是随机模式，也先播放 `start_index` 指定的音乐

### 3. 按钮选中状态的视觉效果
**问题**：按钮的选中和未选中状态颜色差异不明显（浅灰色和深灰色），用户难以区分。

**解决方案**：

#### 场景列表按钮
- **选中状态**：蓝色 `Color(0.3, 0.7, 1.0)`
- **未选中状态**：灰色 `Color(0.7, 0.7, 0.7)`
- **悬停状态**：更亮的颜色

#### 播放模式按钮
- **选中状态**：绿色 `Color(0.2, 1.0, 0.2)`
- **未选中状态**：灰色 `Color(0.8, 0.8, 0.8)`
- **悬停状态**：更亮的颜色

**代码位置**：
- `scripts/music_player_panel.gd` - `_style_scene_button()`
- `scripts/music_player_panel.gd` - `_update_play_mode_ui()`

## 使用体验改进

### 音乐管理流程（在"全部"场景）
1. 选择"全部"场景
2. 看到"上传音乐"和"删除选中"按钮
3. 点击"上传音乐"添加新的音乐文件
4. 上传的音乐会自动添加到"全部"场景的列表
5. 可以删除不需要的音乐（真正删除文件）

### 场景音乐配置流程（在其他场景）
1. 选择一个场景（如"客厅"）
2. 如果该场景未配置音乐，看到提示信息
3. 点击"编辑"按钮
4. 勾选想要在该场景播放的音乐
5. 点击"完成"保存
6. 现在可以看到并播放该场景的音乐列表

### 音乐播放流程
1. 在音乐列表中点击任意音乐
2. 系统从该音乐开始播放
3. 根据当前播放模式播放后续音乐：
   - 单曲循环：一直重复该音乐
   - 顺序播放：按列表顺序播放
   - 随机播放：随机播放其他音乐

### 视觉反馈
- 选中的场景显示为蓝色
- 选中的播放模式显示为绿色
- 正在播放的音乐前面有 ▶ 图标，显示为绿色
- 鼠标悬停时按钮颜色变亮

## 技术细节

### 提示标签控制
```gdscript
if is_edit_mode:
    # 编辑模式：始终显示音乐列表
    hint_label.hide()
    _show_edit_mode_list()
else:
    # 非编辑模式
    if selected_scene != "all" and enabled_music.is_empty():
        # 只显示提示
        hint_label.show()
    else:
        # 显示音乐列表
        hint_label.hide()
        _show_normal_mode_list(enabled_music)
```

### 随机播放起始曲目
```gdscript
# 即使是随机模式，也先播放用户点击的音乐
if play_mode == PlayMode.RANDOM:
    played_tracks.append(start_index)  # 标记已播放

_load_and_play_bgm(current_playlist[current_track_index])
```

### 按钮颜色设置
```gdscript
if is_selected:
    button.add_theme_color_override("font_color", Color(0.3, 0.7, 1.0))
else:
    button.add_theme_color_override("font_color", Color(0.7, 0.7, 0.7))
```

## 测试检查清单
- [ ] 选择"全部"场景，显示"上传音乐"和"删除选中"按钮
- [ ] 选择其他场景，只显示"编辑"按钮
- [ ] 在"全部"场景上传音乐，自动添加到列表
- [ ] 选择未配置音乐的场景，只显示提示，不显示列表
- [ ] 点击"编辑"后，显示所有音乐的勾选列表
- [ ] 在编辑模式下勾选音乐，点击"完成"保存
- [ ] 退出编辑模式后，显示已勾选的音乐列表
- [ ] 随机播放模式下，点击音乐会先播放该音乐
- [ ] 场景按钮选中状态显示为蓝色
- [ ] 播放模式按钮选中状态显示为绿色
- [ ] 正在播放的音乐显示为绿色带 ▶ 图标
- [ ] 鼠标悬停时按钮颜色变化明显
