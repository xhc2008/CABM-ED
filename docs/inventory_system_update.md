# 背包和探索系统更新

## 更新内容

### 1. 宝箱系统改进

**功能：** 宝箱打开后保存状态，可以再次打开

**实现细节：**
- 宝箱打开后，内容保存在 `chest_system.opened_chests` 中
- 每个宝箱的状态包括：`{opened: bool, storage: Array}`
- 再次打开宝箱时，会加载之前保存的状态
- 宝箱状态保存到存档中（`SaveManager.save_data.chest_system_data`）

**使用方法：**
- 玩家可以多次打开同一个宝箱
- 宝箱内的物品变化会自动保存
- 退出探索模式后，宝箱状态会保存到存档

### 2. 背包状态管理

**功能：** 进入探索模式时加载背包状态，返回主场景时保存

**实现细节：**
- 进入探索模式时：
  - 从 `InventoryManager.inventory_container` 加载玩家背包
  - 从存档加载雪狐背包（`SaveManager.save_data.snow_fox_inventory`）
  - 从存档加载宝箱状态（`SaveManager.save_data.chest_system_data`）

- 探索过程中：
  - 所有背包变化只在内存中
  - 宝箱内容变化实时保存到 `chest_system`

- 返回主场景时：
  - 玩家背包保存回 `InventoryManager.inventory_container`
  - 雪狐背包保存到存档
  - 宝箱状态保存到存档

**中途退出：**
- 如果中途退出重进，会回到探索前的状态
- 只有正常返回主场景才会保存变化

### 3. 雪狐背包功能

**功能：** 在主场景可以切换查看雪狐背包，状态保存到存档

**实现细节：**
- 主场景背包UI新增"切换"按钮
- 可以在"仓库"和"雪狐的背包"之间切换
- 雪狐背包大小：12格
- 雪狐背包状态保存在 `SaveManager.save_data.snow_fox_inventory`
- 任何对雪狐背包的修改都会自动保存到存档

**使用方法：**
1. 在主场景打开背包（B键）
2. 点击"切换到雪狐背包"按钮
3. 可以在玩家背包和雪狐背包之间移动物品
4. 点击"切换到仓库"返回仓库视图

### 4. 探索模式中的雪狐背包

**功能：** 在探索模式中可以打开雪狐背包

**使用方法：**
1. 靠近雪狐（距离 < 48像素）
2. 按F键打开雪狐背包
3. 可以在玩家背包和雪狐背包之间移动物品
4. 返回主场景时，雪狐背包状态会保存

## 数据结构

### 存档数据结构

```json
{
  "snow_fox_inventory": [
    {"item_id": "item1", "count": 5},
    null,
    ...
  ],
  "chest_system_data": {
    "opened_chests": {
      "(10, 20)": {
        "opened": true,
        "storage": [
          {"item_id": "item2", "count": 3},
          null,
          ...
        ]
      }
    }
  }
}
```

## 技术要点

1. **内存管理：** 探索模式使用临时变量存储背包状态，避免直接修改全局数据
2. **自动保存：** 宝箱内容变化时自动保存，雪狐背包变化时自动保存到存档
3. **状态隔离：** 探索模式的变化只在正常退出时才保存，中途退出不影响原有数据
4. **深拷贝：** 所有数据传递使用 `duplicate(true)` 确保数据独立

## 测试建议

1. 测试宝箱再次打开功能
2. 测试探索模式中途退出，背包状态是否回滚
3. 测试主场景切换雪狐背包功能
4. 测试探索模式中打开雪狐背包
5. 测试存档保存和加载
