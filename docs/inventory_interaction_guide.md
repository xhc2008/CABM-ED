# 背包交互指南

## 新的交互逻辑

### 1. 单击（Click）
- **空格子**：无操作
- **有物品的格子（未选中状态）**：选中该格子，高亮显示，右侧显示物品详情
- **有物品的格子（已选中状态）**：
  - 点击同一格子：取消选中
  - 点击不同格子：切换选中到新格子

### 2. 拖拽（Drag & Drop）
- **开始拖拽**：按住鼠标左键并移动超过5像素阈值
- **拖拽过程**：显示半透明的物品预览跟随鼠标
- **释放拖拽**：
  - **目标为空格子**：移动物品到目标格子
  - **目标为相同物品**：合并物品（受最大堆叠限制）
    - 如果总数 ≤ 最大堆叠：完全合并
    - 如果总数 > 最大堆叠：目标格子填满，剩余留在原格子
  - **目标为不同物品**：交换两个格子的物品

### 3. 双击（Double Click）
- **前提条件**：格子必须处于选中状态
- **功能**：分离一半物品（向下取整）到最近的空格子
- **示例**：
  - 5个物品 → 分离2个（5/2=2.5，向下取整为2）
  - 3个物品 → 分离1个（3/2=1.5，向下取整为1）
  - 1个物品 → 无法分离
- **查找规则**：优先向后查找空格子，如果没有则向前查找
- **失败情况**：如果没有空格子，显示警告提示

### 4. 跨容器操作
- 所有操作（单击、拖拽、双击）都支持在玩家背包和其他容器（宝箱、仓库等）之间进行
- 拖拽可以在不同容器之间移动/合并/交换物品

## 数据完整性

### 整数数量保证
所有物品数量现在强制为整数类型，避免浮点数问题：
- 添加物品时：`count = int(count)`
- 移除物品时：`count = int(count)`
- 移动/合并时：所有计算都使用 `int()` 转换
- 加载存档时：自动转换为整数
- 显示时：使用 `int()` 确保显示正确

### 关键改进点
1. `StorageContainer.add_item()` - 确保添加的数量是整数
2. `StorageContainer.remove_item()` - 确保移除的数量是整数
3. `StorageContainer.move_item_internal()` - 所有堆叠计算使用整数
4. `StorageContainer.transfer_to()` - 跨容器转移使用整数
5. `StorageContainer.split_item()` - 新增的分离功能使用整数
6. `StorageContainer.load_data()` - 加载时转换为整数
7. `InventorySlot.update_display()` - 显示时转换为整数

## 技术实现细节

### 拖拽检测
- 使用 `DRAG_THRESHOLD = 5.0` 像素作为拖拽触发阈值
- 避免误触：小范围移动不会触发拖拽

### 双击检测
- 使用 `DOUBLE_CLICK_TIME = 0.3` 秒作为双击时间窗口
- 只有在选中状态下的双击才会触发分离操作
- 三击不会被误识别为双击（通过重置时间戳实现）

### 视觉反馈
- 选中状态：格子高亮显示（颜色：1.5, 1.5, 0.8）
- 拖拽预览：半透明物品图标跟随鼠标（透明度：0.7）
- 物品数量：右下角显示数量（数量>1时）

## 使用示例

```gdscript
# 创建背包UI
var inventory_ui = UniversalInventoryUI.new()

# 设置玩家背包
inventory_ui.setup_player_inventory(player_container, "背包")

# 打开背包（仅玩家背包）
inventory_ui.open_inventory_only()

# 打开背包和宝箱
inventory_ui.setup_other_container(chest_container, "宝箱")
inventory_ui.open_with_container()
```

## 注意事项

1. 双击分离需要先选中格子
2. 分离操作需要至少2个物品
3. 分离需要有空格子可用
4. 所有数量计算都是整数，不会出现小数
5. 拖拽预览会自动跟随鼠标移动
